<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Chat Global</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      h1 {
        margin: 0 0 16px 0;
        text-align: center;
      }

      #chat-container {
        margin-top: 20px;
      }

      #messages {
        list-style: none;
        padding: 0;
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }

      #messages li {
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      #send-section {
        margin-top: 10px;
      }

      .lang-buttons {
        margin-top: 20px;
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .lang-buttons button {
        padding: 8px 12px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <h1>Chat Global</h1>

    <div id="language-select">
      <h3>Entrar em um chat do seu idioma</h3>
      <div class="lang-buttons">
        <button onclick="goToLangChat('pt')">Português</button>
        <button onclick="goToLangChat('en')">Inglês</button>
        <button onclick="goToLangChat('es')">Espanhol</button>
      </div>
    </div>

    <div id="chat-container">
      <input id="user" placeholder="Seu nome" />
      <input id="message" placeholder="Mensagem" />
      <button id="sendBtn">Enviar</button>

      <ul id="messages"></ul>
      <div
        id="typingStatus"
        style="font-size: 14px; color: gray; margin-top: 5px"
      ></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
      const socket = io('http://172.23.130.210:3000');
      const user = document.querySelector('#user');
      const msg = document.querySelector('#message');
      const list = document.querySelector('#messages');
      const typingStatus = document.getElementById('typingStatus');
      let typingTimeout;
      const TYPING_INTERVAL = 5000;

      socket.emit('join_room', { lang: 'global' });

      document.querySelector('#sendBtn').onclick = () => {
        if (!msg.value.trim()) return;

        socket.emit('register_user', { user: user.value || 'Anônimo' });

        socket.emit('send_message', {
          user: user.value || 'Anônimo',
          message: msg.value,
        });

        msg.value = '';
      };

      msg.addEventListener('input', () => {
        socket.emit('typing', {
          user: user.value || 'Anônimo',
          room: 'global',
        });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit('stop_typing', {
            user: user.value || 'Anônimo',
            room: 'global',
          });
        }, TYPING_INTERVAL);
      });

      socket.on('new_message', (data) => {
        const li = document.createElement('li');
        const time = new Date(data.timestamp).toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit',
        });
        li.textContent = `(${time}) ${data.user}: ${data.message}`;
        list.appendChild(li);
      });

      // aviso mencao
      socket.on('highlight_message', (data) => {
        const li = document.createElement('li');
        li.style.background = '#ffff99';
        li.style.fontWeight = 'bold';
        const time = new Date(data.timestamp).toLocaleTimeString(undefined, {
          hour: '2-digit',
          minute: '2-digit',
        });
        li.textContent = `(Mencionado) (${time}) ${data.from}: ${data.message}`;
        list.appendChild(li);
      });

      socket.on('users_typing_update', (typingUsers) => {
        if (!typingUsers || typingUsers.length === 0) {
          typingStatus.textContent = '';
          return;
        }
        if (typingUsers.length === 1) {
          typingStatus.textContent = `${typingUsers[0]} está digitando...`;
          return;
        }
        if (typingUsers.length === 2) {
          typingStatus.textContent = `${typingUsers[0]} e ${typingUsers[1]} estão digitando...`;
          return;
        }
        typingStatus.textContent = `${typingUsers.length} pessoas estão digitando...`;
      });

      function goToLangChat(lang) {
        window.location.href = `chat-lang.html?lang=${lang}`;
      }
    </script>
  </body>
</html>
