<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <title>Chat por Idioma</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
      }

      h1 {
        margin: 0 0 16px 0;
        text-align: center;
      }

      #chat-container {
        margin-top: 20px;
      }

      #messages {
        list-style: none;
        padding: 0;
        border: 1px solid #ccc;
        height: 300px;
        overflow-y: auto;
        margin-top: 10px;
      }

      #messages li {
        padding: 5px;
        border-bottom: 1px solid #eee;
      }

      #send-section {
        margin-top: 10px;
      }

      .lang-buttons {
        margin-top: 20px;
        display: flex;
        gap: 12px;
        justify-content: center;
      }

      .lang-buttons button {
        padding: 8px 12px;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <h1 id="roomTitle"></h1>
    <button class="back-btn" onclick="goBack()">Voltar para Home</button>

    <div id="chat-container">
      <input id="user" placeholder="Seu nome" />
      <input id="message" placeholder="Mensagem" />
      <button id="sendBtn">Enviar</button>

      <ul id="messages"></ul>
      <div id="typingStatus" style="font-size: 14px; color: gray; margin-top: 5px;"></div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
      
      const params = new URLSearchParams(window.location.search);
      const lang = params.get("lang") || "pt";

      const languages = {
        pt: { label: "Portugu锚s", flag: "ю" },
        en: { label: "English", flag: "吼" },
        es: { label: "Espa帽ol", flag: "" },
      };

      const langMeta = languages[lang] || { label: "Chat por Idioma", flag: "" };
      document.getElementById("roomTitle").textContent = `${langMeta.flag} Chat em ${langMeta.label}`.trim();
      document.title = `${langMeta.flag} Chat em ${langMeta.label}`.trim();

      const socket = io("http://localhost:3000");

      const user = document.querySelector("#user");
      const msg = document.querySelector("#message");
      const list = document.querySelector("#messages");
      const typingStatus = document.getElementById("typingStatus");
      let typingTimeout;
      const TYPING_INTERVAL = 1500; // ms

      
      socket.emit("join_room", { lang });

      document.querySelector("#sendBtn").onclick = () => {
        if (!msg.value.trim()) return;

        socket.emit("register_user", { user: user.value || "An么nimo" });

        socket.emit("send_message_lang", {
          user: user.value || "An么nimo",
          message: msg.value,
          lang: lang,
        });

        msg.value = "";
      };

      msg.addEventListener("input", () => {
        socket.emit("typing", { user: user.value || "An么nimo", room: lang });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("stop_typing", { user: user.value || "An么nimo", room: lang });
        }, TYPING_INTERVAL);
      });

      socket.on("new_message_lang", (data) => {
        const li = document.createElement("li");
        const time = new Date(data.timestamp).toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });
        li.textContent = `(${time}) ${langMeta.flag} ${data.user}: ${data.message}`;
        list.appendChild(li);
      });

      // highlight messages when user is mentioned
      socket.on("highlight_message", (data) => {
        const li = document.createElement("li");
        li.style.background = "#ffff99";
        li.style.fontWeight = "bold";
        const time = new Date(data.timestamp).toLocaleTimeString(undefined, {
          hour: "2-digit",
          minute: "2-digit",
        });
        li.textContent = `(Mencionado) (${time}) ${data.from}: ${data.message}`;
        list.appendChild(li);
      });

      function goBack() {
        window.location.href = "chat.html";
      }
      
      //mostrando o usuario digitando
      socket.on("users_typing_update", (typingUsers) => {
        if (!typingUsers || typingUsers.length === 0) {
          typingStatus.textContent = "";
          return;
        }
        if (typingUsers.length === 1) {
          typingStatus.textContent = `${typingUsers[0]} est谩 digitando...`;
          return;
        }
        if (typingUsers.length === 2) {
          typingStatus.textContent = `${typingUsers[0]} e ${typingUsers[1]} est茫o digitando...`;
          return;
        }
        typingStatus.textContent = `${typingUsers.length} pessoas est茫o digitando...`;
      });
    </script>
  </body>
</html>
